#!/bin/zsh

printf "%b\n" "                                                                                      ▄╥╗╦╦╦╗╗╖╓"
printf "%b\n" "                                                                                   ▄▓████▓╝▀╩╙╙╙╩▒╠▒═"
printf "%b\n" "                                                                                 ▓█▀▀╙      ▄▄▄▄╓  ╙╚╦▒┐"
printf "%b\n" "                                                                               ╓▀   ╓▄▄▓▓█████████▓▄  └▒╗"
printf "%b\n" "                                                                              ╓▒╓▄▓███████▓╬▓▓█╬╫╣▓▓▓▓▄ ╚▓"
printf "%b\n" "                                                                              ▓▓████╩           └└╙╣▓▓▓█└▀▓▄"
printf "%b\n" "                                                   \033[32m╔╦╓▒╝\033[0m\033[33m╩▓╩╪╫▄╔╗╓\033[0m            ╟███▓└                 └▀██▒   └┐"
printf "%b\n" "                                          \033[32m┌╔▄▄╫╣▒▒▌▓╟▐▒▒▒\033[0m\033[33m▌▀╪╢╣│▌╙▌\033[0m           ███╩░░░─┘                ╠▒▒  ▀▓╦└═╓"
printf "%b\n" "                                   \033[32m╗▄▒▌▓╟╟░▌▌▓╟▐▒▒▌▓╟╟╣╬▒\033[0m\033[33m▓╗╪▄╣╓╠╙▌\033[0m          ▐██╬▒▒▒▒▒░┐░    ┌╓░░░╓░▀█▀╠░░░         ═┐"
printf "%b\n" "                                   \033[32m╣▒▌▌█╟▐▒▌▌▓╟▐▒▒▌█╫╣╣╬▓\033[0m\033[33m▓╣▓╣╣╠╠▀▌\033[0m          ╞█▓▓╬╣▒╠▒╠╦▒░▒▒▒╠▒╬╣╬▒▒║████▓▓▄░┐┌         ▐═┌"
printf "%b\n" "                                   \033[32m╣▒▌██╫╫▒▓██▓╣▓███████\033[0m\033[33m██▓█▓▓╬╬╬▌\033[0m          └█▓▓▓╣╬▒╬▒╩╠╫╣▓▓▓▓█▓╨╙└└       ╙╙▀▀▀▓▓▄▄▄▄▄▄▄▄═"
printf "%b\n" "                                   \033[32m█▓████╣▓█████████▀█▓█╝█░▒██╬╫╬▓▄▄\033[0m         ▓▓█▓▓╬╬▒░╠ ╠╚╬▓██▌"
printf "%b\n" "                                   ███████▀▀▓▓╨█\033[32m▓▒▓╩█▓▓▌░╟▄▄╣▌▄▐ ┤\033[0m█\033[34m▀▒╗╫▒▄▀\033[0m   ╙▓█▓▓▓╬▐░░░╔░╚╠╣▓"
printf "%b\n" "                        \033[34m┌─╦▐░╬\033[0m▓█▀▀\033[31m╦╓▒╫▐─▓└▌╘ ▐╒\033[0m█\033[32m▄▓▓▓▓▓▓▌╠╫╢╚╢▌└╙╙│\033[0m█\033[34m═╤▄▄▄ ╟\033[0m    ╫█▓▓▌╬╬╠▒░└└ ░╠╬▄"
printf "%b\n" "                    \033[34m╟▌▀╙▒▓▒▄▄╣\033[0m\033[31m╙▒╟ ▌╠ ╠▐ ╚ ░  ▐░\033[0m█\033[32m▒▒▓▒▓▓▓▓▓▓▀▀╫▓▀▓▀╪\033[0m█\033[34m▄▄▒╔░ ╟\033[0m     ▐╣╫▓╣▒╬░╦░░╒░╒╠╣"
printf "%b\n" "                    \033[34m╞▀╠╠╡▒▓▓█\033[0m█\033[31m▐▒╟ ▒▐ ╠▐ ╠ ▒ ░▐░\033[0m█\033[32m▓╬▓╬▓██▓▓▓▓▓╢▓▀▓╣▓\033[0m█\033[34m▒╢╩╠▓▀▓─\033[0m     ╫▓▓█▓╬▒└▒╢╟▒▄▒╣╩▌╖"
printf "%b\n" "                    \033[34m╞▀╬╣╠▓██\033[0m██\033[31m▐▒╫░▌║░▌░▒╫░▒░▒╫╬\033[0m█\033[32m█▓█▓████▓█▓███▓▓╬▓\033[0m█▓▓\033[34m█╝▀╙\033[0m╠╩╣▒╢▄╔─╩██▓██▓╣▓▓▓▀╙└  └═╓"
printf "%b\n" "                    ▐\033[34m▓▓▓█\033[0m█████\033[31m▐╬╫╠▌╢▒▌╠▒╣▒▓╣╣▓▓\033[0m█\033[32m██████████████▓█\033[0m████▓▒█╞▌║▒  ▐ ╣╙╩╟▓███▓▓▓╙    ╓   ▀▄"
printf "%b\n" "                    ▐\033[34m████\033[0m█████\033[31m╣╝▓▓▓╝╬█▓██▓█████\033[0m█\033[32m███▀▀▓▌\033[0m▓╨▓\033[34m╙▌▐░╟─▌╙╙\033[0m▌▒▓╬╫╩╣▓ ▒╙╙▐ ▀═▓████╙  ╔╗▄╚╓╧│╕╡╚▀▄"
printf "%b\n" "                    ╨▀▀▓╩▄└\033[31m▓ ▓▄╠─╠└└╟▓▒▀\033[0m▀╬▓╟╨▓\033[34m╙▒╟\033[0m ╬ ▌▐ ╠ ▌ ╣\033[0m▐╪╟\033[34m ▌▀▀▓╗▒▄▄▄▄╠\033[0m─▀╤╗▒╓▄ █▓█▌╦╣▓╬╩▒▄┴ ╒└ ═  ─ ═"
printf "%b\n" "           ▓█╥╡▐▒▐ \033[31m╟ ╠ ╩ ╠ ╞ │╗╞ ╠▒▒\033[0m╫\033[34m╝▌╟▐─▌▐─╬ ░║ ▒ ╠╘ ╠ ▌ ▒\033[0m▐░\033[34m╟░▓▓╬▓▄▒▄▒░\033[0m ╟▒▀║╣╣╓▌┌▓█╣▓██▓▓╣▒║╙══ ╒ ▐  ╔╜└═"
printf "%b\n" "           ▌╫\033[31m ▌▐─▐ ╙ ░ ░ │ ╠ ║ ╞ ╠╣▓\033[0m█\033[34m▐▌╟▐ ▌▐ ╬ ░║ ▒ ╠▐ ╠ ▒ ▒▐│║╠▌▄╓▌░▓╬╝╬╠╟\033[0m▒▌▓╬▓▒▌╠▌█████╣╣╠╢┘╙─  ╕  ─   ─╨▄"
printf "%b\n" "           ▌\033[31m▓░▌▐═▐ ▐ ░ ▐ │ ╠┌╞ ░░▓▓\033[0m██\033[34m▒▌╟▐─▌▐ ╬ ▒║ ╬ ▒▐╕╠ ▒░▒▐▒╫╬▌┐│▌╩╣╬╠▀▀▓\033[0m▓█╫╢█████████▓╬▓▄▒╞└╚░▌╓  └   ╓┐╔▀"
printf "%b\n" "           ▌\033[31m▓░▌╔▒▐░║░▐░╠ ╠ ║│╠░▐▒▓█\033[0m██\033[34m╣▌╟▐▒▌▐░▓▐▒╟╦╬▒╬║╬▓▒▓╣╬╣╬▓╬▓╬╠▓▀╣▀▀▓╪▓\033[0m███████████▓█▓╣▒▒╨▓▄╓▄╩▄▀─╕▄  ╦  ┌└▄"
printf "%b\n" "           \033[31m╢▓░▌╠▒║░╟░╢░╟░╟░╫▒╫▒╠▒▓█\033[0m██\033[34m╣▓╫╬▒▓╣╬▓╣╬╣╬▓╬▓╣╬▓╬█▓██▓█╣█╣╢▓╬▓╬╢▓╬▓\033[0m█╩╬▓╫╬╩▀███▓▒▓▒╠╫▄░╓╝  ╛╓╓┘  ╘      ▄"
printf "%b\n" "           \033[31m╫█▒▌╬▒╫▒╫▒╣╠╫▒╫▒╫╠╫╬╢▒█\033[0m███\033[34m╣██▓▓██▓█▓▓█\033[0m████████████▀▀▀▀╠▓╚╝██╩╠▌▀▀▀█╬▓▒▀  ╙█▓█╬█▒░░▓    ╕  ╓─  ═┐╗  ▐▀"
printf "%b\n" "           ▌\033[31m█╣▓╬▓▓▓█▓▓▓▓▓▓▓█▓███▓\033[0m████\033[34m███\033[0m████▀▀▀▀╠▌╩╫╜╬╙███──╫ ╟╟▀ ╠  ╫    ╟╠ ▌╙██▓╡▄  ▀▓╠╠╬╬╜╙▀═▌  ─   ▐└└  ╖└▌ ▌"
printf "%b\n" "           ╣█\033[31m╫█▓▓╝\033[0m▀▀▀█▓▓████████▓▌╫▀╫╛▐▒▀─╙─├ ▐    ▒▒╞ ██▒╗╗╣╗╝╞▀▀╠╙╙█─└╙┘╟╠═╬═╣██▌╕▌  ╙▌╜╩▒╔╔▌   ╙└═▄═└╕ ╡  └ └╣"
printf "%b\n" "             ╟▌─╫─▌▓ ╟  ╟███─▌▐▒▐─└ └─  │          ▌▒│ ██╡  ▐ ╙╞╥┌╠╓▄▓╓╓┌┐╠╞ ▌ ╟▓╬╫▌ ▓  └╡░░╠ └▀▀└└═╜         ╔╓╬─"
printf "%b\n" " ╣▄└═╥▓─╒┐╓╓ ╟▄╗╣╗╡▌▀▀▀╙╫╝╣█─▌▐▒▐ │                ═─╞ ██┤▀╚╠╙╟╫╙└╬╤ █╓└▒▒╚╞╙│└▓▒╚╚█▌ █   ╪▒╣▒╕ └▒╙  ╙▀╪▄┌▄▀▀▀▌ ▐═"
printf "%b\n" "  ╬ ┐  ╙▓═╩╠▓█░ ▐ │▌╓▐▄▄╫─╟█ ▌╞▒▐ └ ╒   ╒        ─ ═ ╞░██╪▀▀╣▀╣╞╩╙╠╙╚█╠ ─▒╡╟╠▓▒▓█▓╩╠╟▌╙▓▌╚╨╠▒╙▀▌│   │╠   ▒┌▄ ╓╩▀▓"
printf "%b\n" "   ▀┐    ▀▌╥╠█╬╠╟└╫▌ ╠┌ ╫▒║█▒▌▐▒▐▒▐─▐  ─▐    ░   ▒░▒░║░██▓▄╢▓▐▓╞▓╬▓▄▄█╝╪╬▓╣█╫▓▄█▀╙   ╙▓╣▓   ╚╕░▀▄▒▄▄▓░░┐─└▐╙╙╠┌░▌"
printf "%b\n" "    ╙▀▒▒▒╧╣█▓█▀▀╟▀╠▌╙╠││▓▒╫█▒▌▐▒▐▒▐▒▐▒▐▒▐▒░░╔░╔▒░▒▐▒▒╟▒██▓▄▄╫▄╣╫▌╗▓╣╗█▓▒╬▓▓█╝▌╝       ╙▄╟▌   ╔▌░░╙╣▒▓▓▒░╔▄╣░░╠█╣▀"
printf "%b\n" "       ▀▓▓▓▓██▓▄█╣▌█▀╣╝▀╫███▒▌║▒║▒▐▒║▒║▒║▒╣▒║▒║▒╠▒║▒▒╢╬████▓█▓▓╝╝╝█▓╬▓█████▄═▌┌  ▄▀╚ ══╙▄█▌   ╟▓▒▒▒▒▌└╙╠▌░▒╙╟╬╬▌"
printf "%b\n" "     ╙╬▒═╝████▓▓▓▓▓▓╬▓╬╬████▌█╣▓╣╩╝╫╫▓▀▀╬╠▓▓▓▓╫╝╨╬╬▓╬▓╛    ░░╙└╙╖▄▓▓▄▓▓██▀╙▄═│─╟▀  ┌  ▄╛╟▌█▓▄▒▄▓╫╫▒║▓▓▄╬▓█▄▄█╬▓"
printf "%b\n" "        └▀╗▄▄╫█▓▌╜╜╙╙╙╚╚╛└ ▐▓▓▓▄▄▄╟▓▓▓║▄╗▄█╩▀▓▀▓██╘▓▀╝╫████╞╬█▄▄▄╠╠╠████▀╠█╛░▄▄▄▒▄░╓▄██▓▌╩██▓▄▄▓▀╫╬╣▒╠▓▓█╬╣╬╬█"
printf "%b\n" "            ╙▀█▓░▓▓▓██╣╢███▌▄╟╝██▒╩▓█▄██▓█▌▌╢╣▓▄╣███╬ ╠░██▌╣░╟╫█████▀▄╧└  └╙╠╩   ╙╙│▄╩╣└▀▀▓█▓╬▓╠▒▓╫▓█▓█╣▓╬╣█▀"
printf "%b\n" "                █████▐▒╙▒██▐▄╙▒██▐▒╟╟██████╙▒╬██████▄▓▄████▄▓▓█████▀└      ▄──│ ┌ ▄█▓█┌╦▓█▓██▓▓▌╠╬██▓█▓▓█▓▀"
printf "%b\n" "                 ╙╝███▄▓████▓▓██████████████████▓╬╬╠████▀▀▓▓▓████▌ ╓═░ ▄▄██▒▒░░▄▓█╬╣└└╩╟▓╣█▓╠███▓╬╬▓████╩─"
printf "%b\n" "                     ▀█████████████▓▓▓█████▀▀╬╬╬╬╬╬╬╬╣█▓▒░▄▄▓▓▀╬▓█▓▀▓╬╚╩╢▒▓▓████▓╬█▄▓██╬╠╣██╬▓███▒╚█▓╝▀"
printf "%b\n" "                       └╙╝▓▓█▓╬╬╬█▒╙╠╬╣███▓╬╬╢▒╬▄▓██╬╡▒╠╠╩╩╙░░░║▓▒╠╠▄▓██████╬╠╠╬█╬╬╬╬█▓██████▓██╩▌═╙"
printf "%b\n" "                           └╙╝█▓╬╬╢▓╬╬╬╫▓╬███████████▓▄▄░▄▒▄▄▒╬███████╣╬╬╣█╬██████████████╬█╝▀╙└"
printf "%b\n" "                                 ╙▀▓▓╣▓▓▓█████████████████▓╬╬╫╬▓▓██████████████████▓██╝▀▀└"
printf "%b\n" "                                     └╙╝╬▓▓▓█▓▓▓████████████████████████████▓▀▀▀╙╙└"
printf "%b\n" "                                           └╙▀▀▀▀▀▀▀▀╙████╩▌╙   └████▀"
printf "%b\n" "                                                      ╟██▄ ▌     ╙██▓╦▌"
printf "%b\n" "                                                       ██░╙─       ▀▓╬╦╙╖"
printf "%b\n" "                                                       ╟▓▒ ▌        └╬▓╬╦╙"
printf "%b\n" "                                                       ▐╩╬─╞          ▀╬▓▓ ╘"
printf "%b\n" "                                                       ▐▒╬╬ ▄          ▓╬█▓ ╣▒╗─┐┌"
printf "%b\n" "                                                       ▐╬▓▓░╟         ╙▀╚╙█▓▄╙▀╬╩╙┘└└└╙╙╙╙╚▀▀▒╥"
printf "%b\n" "                        ──────░░░░░░░░▒▒▒▒▒▒▒▒╗▄▄▄▄▄▄▄▓█▓██▄╙▀▓╣╣╗╗╡╚╚╚╠╠╠▀▀▀▀▓▓╗▄▄▄▄▄▄╦╖╖╓  ▌"
printf "%b\n" "                                        ╙╙╙╙╙╙╚╚╩╩╩▀▀▀▀▀▀▀▀██▓▓▄▄▄╓╔┬┌       ╓▄▄╝╝╗"
printf "%b\n" "                                                                   └└╙└╙╙└"

echo "░▒▓█▓▒░░▒▓█▓▒░░▒▓█▓▒░░▒▓██████▓▒░▒▓████████▓▒░▒▓██████▓▒░░▒▓█▓▒░░▒▓█▓▒░▒▓███████▓▒░░▒▓█▓▒░░▒▓█▓▒░░▒▓██████▓▒░░▒▓█▓▒░░▒▓█▓▒░ "
echo "░▒▓█▓▒░░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░ "
echo "░▒▓█▓▒░░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓█▓▒░      ░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░      ░▒▓█▓▒░░▒▓█▓▒░ "
echo "░▒▓█▓▒░░▒▓█▓▒░░▒▓█▓▒░▒▓████████▓▒░ ░▒▓█▓▒░  ░▒▓█▓▒░      ░▒▓████████▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░      ░▒▓███████▓▒░  "
echo "░▒▓█▓▒░░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓█▓▒░      ░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░      ░▒▓█▓▒░░▒▓█▓▒░ "
echo "░▒▓█▓▒░░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░ "
echo " ░▒▓█████████████▓▒░░▒▓█▓▒░░▒▓█▓▒░ ░▒▓█▓▒░   ░▒▓██████▓▒░░▒▓█▓▒░░▒▓█▓▒░▒▓███████▓▒░ ░▒▓██████▓▒░ ░▒▓██████▓▒░░▒▓█▓▒░░▒▓█▓▒░ "

# Declare an associative array for container names and their health check URLs
typeset -A containers
containers["portainer"]="https://192.168.1.100:9443"
# containers["homeassistant"]="http://192.168.1.100:8123"
# Add more containers here

RESTART_THRESHOLD=3 # Number of consecutive failures before a container is restarted
WAIT_AFTER_RESTART=30 # Seconds to wait after restarting a container for services to stabilize

# Basically a logtee for dummie dumdums
log_message() {
	echo "$1"
	logger -t "Docker containers Watchdog" -p "daemon.warn" "$1"
}

# Function to monitor and restart a container if necessary
monitor_container() {
	local container_name=$1
	local health_check_url=$2
	local failures=0

	while true; do
		if curl --insecure --silent --fail $health_check_url > /dev/null; then
			# Health check passed
			failures=0
		else
			# Health check failed
			((failures++))
			log_message "Health check failed for $container_name ($failures)"
		fi

		# Check if failures reached the threshold
		if [ $failures -ge $RESTART_THRESHOLD ]; then
			log_message "Restarting $container_name due to health check failure."
			docker restart $container_name
			failures=0 # Reset failures after restart
			log_message "Waiting $WAIT_AFTER_RESTART seconds for $container_name services to stabilize after restart."
			sleep $WAIT_AFTER_RESTART
		fi

		sleep 60 # Wait for 60 seconds before the next check
	done
}

# Soooo brutal \m/
kill_all_children() {
	log_message "Killing all children"
	pkill -P $$
	exit # Ensure exit on SIGINT trap catch
}
trap kill_all_children SIGINT EXIT

# Loop through all containers and start monitoring in the background
for container_name in "${(@k)containers}"; do
	monitor_container $container_name ${containers[$container_name]} &
done

wait # Wait for all background jobs to finish (they won't in this case)
